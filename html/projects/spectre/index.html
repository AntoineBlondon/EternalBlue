<!DOCTYPE html>
<html>
<head>
    <title>Spectre</title>
    <link rel="stylesheet" href="../../css/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <header>
        <div class="navbar">
            <a href="./">home</a>
            <a href="./projects">projects</a>
            <a href="./about">about</a>
        </div>
    </header>
    <h1>Spectre</h1>
    
    <canvas id="spectrogram"></canvas>

    <script>
      const canvas = document.getElementById('spectrogram');
      const ctx = canvas.getContext('2d');

      const freqAxisWidth = 50; // space for labels
      const dataHeight = 256;
      canvas.width = window.innerWidth / 4;
      canvas.height = dataHeight;

      let audioContext, analyser, dataArray;

      async function setupAudio() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(stream);

        analyser = audioContext.createAnalyser();
        analyser.fftSize = 512;
        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);

        source.connect(analyser);
        draw();
      }

      function drawAxis() {
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, freqAxisWidth, canvas.height);
        ctx.strokeStyle = "white";
        ctx.fillStyle = "white";
        ctx.font = "10px sans-serif";
        ctx.textAlign = "right";

        const nyquist = audioContext.sampleRate / 2;
        const step = 32; // vertical step in pixels

        for (let y = 0; y <= canvas.height; y += step) {
          const freq = Math.round(nyquist * (1 - y / canvas.height));
          ctx.beginPath();
          ctx.moveTo(freqAxisWidth - 5, y);
          ctx.lineTo(freqAxisWidth, y);
          ctx.stroke();
          ctx.fillText(freq + " Hz", freqAxisWidth - 7, y + 3);
        }
      }

      function draw() {
        requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);

        // Shift image left excluding axis area
        const imageData = ctx.getImageData(freqAxisWidth + 1, 0, canvas.width - freqAxisWidth - 1, canvas.height);
        ctx.putImageData(imageData, freqAxisWidth, 0);

        // Draw the new frequency column
        for (let i = 0; i < dataArray.length; i++) {
          const value = dataArray[i];
          const r = value;
          const g = value;
          const b = 255 - value;
          ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
          ctx.fillRect(canvas.width - 1, canvas.height - i, 1, 1);
        }

        drawAxis();
      }

      setupAudio();
    </script>
</body>
</html>
