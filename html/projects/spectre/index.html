<!DOCTYPE html>
<html>
<head>
    <title>Spectre</title>
    <link rel="stylesheet" href="../../css/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<header>
    <div class="navbar">
        <a href="./">home</a>
        <a href="./projects">projects</a>
        <a href="./about">about</a>
    </div>
</header>
<h1>Spectre</h1>

<canvas id="spectrogram" style="width: 100%;"></canvas>

<script>
const canvas = document.getElementById('spectrogram');
const ctx = canvas.getContext('2d');

const freqAxisWidth = 60;
const canvasHeight = 256;
canvas.height = canvasHeight;

let audioContext, analyser, dataArray;

// ERB scale mapping
function freqToERB(f) {
  return 21.4 * Math.log10(0.00437 * f + 1);
}
function erbToFreq(e) {
  return (Math.pow(10, e / 21.4) - 1) / 0.00437;
}

function getERBIndexMap(nyquist, size) {
  const map = new Array(size);
  const maxERB = freqToERB(nyquist);
  for (let y = 0; y < size; y++) {
    const erbRatio = 1 - y / size; // from top (high) to bottom (low)
    const erb = erbRatio * maxERB;
    const freq = erbToFreq(erb);
    const bin = Math.floor(freq / nyquist * (analyser.frequencyBinCount - 1));
    map[y] = bin;
  }
  return map;
}

function drawAxis(nyquist) {
  ctx.fillStyle = "black";
  ctx.fillRect(0, 0, freqAxisWidth, canvas.height);
  ctx.strokeStyle = "white";
  ctx.fillStyle = "white";
  ctx.font = "10px sans-serif";
  ctx.textAlign = "right";

  const maxERB = freqToERB(nyquist);
  const labeledFrequencies = [100, 200, 300, 400, 500, 1000, 2000, 3000];

  for (const freq of labeledFrequencies) {
    if (freq > nyquist) continue; // Skip labels above Nyquist limit
    const erb = freqToERB(freq);
    const erbRatio = erb / maxERB;
    const y = (1 - erbRatio) * canvas.height;

    ctx.beginPath();
    ctx.moveTo(freqAxisWidth - 5, y);
    ctx.lineTo(freqAxisWidth, y);
    ctx.stroke();
    ctx.fillText(freq + " Hz", freqAxisWidth - 7, y + 3);
  }
}


async function setupAudio() {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const source = audioContext.createMediaStreamSource(stream);

  analyser = audioContext.createAnalyser();
  analyser.fftSize = 512 * 2 ** 5;
  const bufferLength = analyser.frequencyBinCount;
  dataArray = new Uint8Array(bufferLength);
  source.connect(analyser);

  const nyquist = audioContext.sampleRate / 2;
  const erbIndexMap = getERBIndexMap(nyquist, canvasHeight);

  function draw() {
    requestAnimationFrame(draw);
    analyser.getByteFrequencyData(dataArray);

    const imageData = ctx.getImageData(freqAxisWidth + 1, 0, canvas.width - freqAxisWidth - 1, canvas.height);
    ctx.putImageData(imageData, freqAxisWidth, 0);

    for (let y = 0; y < canvasHeight; y++) {
      const i = erbIndexMap[y];
      const value = dataArray[i] ?? 0;
      const r = value;
      const g = value;
      const b = 255 - value;
      ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
      ctx.fillRect(canvas.width - 1, y, 1, 1);
    }

    drawAxis(nyquist);
  }

  draw();
}

setupAudio();
</script>
</body>
</html>
